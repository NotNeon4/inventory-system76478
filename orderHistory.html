<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jigsaw Order History</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables from index.html for consistency */
    :root {
      --primary-blue: #007AFF;
      --text-dark: #1D1D1F;
      --text-medium: #6E6E73;
      --background-light: #F5F5F7;
      --white: #FFFFFF;
      --border-light: #E8E8ED;
      --success-green: #34C759;
      --error-red: #FF3B30;
      --warning-orange: #FF9500;
      --table-stripe: #FDFDFE; /* For striped table rows */
      --table-hover: #F0F0F2; /* For table row hover */
      --button-hover-bg: rgba(0, 122, 255, 0.08); /* Blue button hover */
    }

    /* Dark Mode Colors (copied from index.html for consistency) */
    body.dark-mode {
      --primary-blue: #0A84FF;
      --text-dark: #F5F5F7;
      --text-medium: #AEAEB2;
      --background-light: #1C1C1E;
      --white: #2C2C2E;
      --border-light: #48484A;
      --success-green: #30D158;
      --error-red: #FF453A;
      --warning-orange: #FF9F0A;
      --table-stripe: #2C2C2E;
      --table-hover: #3A3A3C;
      --button-hover-bg: rgba(10, 132, 255, 0.2);
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-light);
      color: var(--text-dark);
      line-height: 1.5;
    }

    .header {
      background-color: var(--white);
      padding: 15px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .header .logo {
      height: 35px;
      display: block;
    }
    .header-nav button {
      background: none;
      border: none;
      color: var(--primary-blue);
      font-size: 16px;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-left: 10px;
    }
    .header-nav button:hover {
      background-color: var(--button-hover-bg);
    }

    .container {
      max-width: 960px;
      margin: 24px auto;
      padding: 24px;
      background-color: var(--white);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow-x: auto; /* For table responsiveness */
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-light);
    }

    /* Message Display (copied from index.html) */
    #messages {
      margin-top: 24px;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      opacity: 0; /* Hidden by default for smooth transition */
      transition: opacity 0.3s ease-in-out;
    }
    #messages.show { /* For visibility */
        opacity: 1;
    }
    .message.success {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success-green);
      border: 1px solid var(--success-green);
    }
    .message.error {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--error-red);
      border: 1px solid var(--error-red);
    }
    .message.info {
      background-color: rgba(0, 122, 255, 0.1);
      color: var(--primary-blue);
      border: 1px solid var(--primary-blue);
    }
    /* Dark mode message colors */
    body.dark-mode .message.success { background-color: rgba(48, 209, 88, 0.2); }
    body.dark-mode .message.error { background-color: rgba(255, 69, 58, 0.2); }
    body.dark-mode .message.info { background-color: rgba(10, 132, 255, 0.2); }


    /* Order History Table Styling */
    .order-history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: var(--white); /* Consistent with containers */
        border-radius: 8px; /* Consistent with containers */
        overflow: hidden; /* Ensures border-radius applies to table content */
    }
    body.dark-mode .order-history-table {
        background-color: var(--background-dark); /* Darker table background */
    }
    .order-history-table th, .order-history-table td {
        border: 1px solid var(--border-light);
        padding: 12px;
        text-align: left;
        vertical-align: top;
        font-size: 15px;
        color: var(--text-dark); /* Consistent text color */
    }
    body.dark-mode .order-history-table th, body.dark-mode .order-history-table td {
        border-color: var(--border-light); /* Dark mode border */
    }
    .order-history-table th {
        background-color: var(--background-light); /* Header background */
        font-weight: 600;
        color: var(--text-dark);
    }
    body.dark-mode .order-history-table th {
        background-color: var(--white); /* Darker header background */
        color: var(--text-dark);
    }
    .order-history-table tr:nth-child(even) {
        background-color: var(--table-stripe); /* Use variable for stripe */
    }
    .order-history-table tr:hover {
        background-color: var(--table-hover); /* Use variable for hover */
    }
    
    /* List styles within table cells */
    .order-item-list, .email-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 0.9em; /* Slightly smaller font for list items in table */
    }
    .order-item-list li, .email-list li {
        margin-bottom: 4px; /* Reduced margin */
        display: flex;
        flex-direction: column; /* Stack item details and notes */
        align-items: flex-start; /* Align to top if content wraps */
        gap: 2px; /* Smaller gap between lines */
        word-break: break-word; /* Allow long words to break */
        color: var(--text-medium); /* Lighter text color */
    }
    .order-item-list li:last-child, .email-list li:last-child {
        margin-bottom: 0;
    }
    .order-item-list li strong { /* For item ID */
        color: var(--text-dark);
    }
    .order-item-list li .item-name-qty { /* For item name and quantity */
        flex-grow: 1; /* Allow to grow */
    }
    .item-notes-display { /* For item notes */
        font-size: 0.8em;
        font-style: italic;
        color: var(--text-medium);
        white-space: pre-wrap; /* Preserve formatting and break lines */
    }
    .email-list li span {
        flex-grow: 1;
        margin-right: 5px;
    }
    .order-item-list button, .email-list button {
        background-color: var(--error-red); /* Use variable */
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75em; /* Smaller font for buttons in lists */
        transition: background-color 0.2s ease;
        flex-shrink: 0; /* Prevent button from shrinking */
        margin-top: 5px; /* Space between notes and button */
    }
    .order-item-list button:hover, .email-list button:hover {
        background-color: #E63946;
    }

    .status-dropdown {
        padding: 8px;
        border-radius: 6px;
        border: 1px solid var(--border-light);
        font-size: 15px;
        color: var(--text-dark);
        background-color: var(--white);
        cursor: pointer;
    }
    body.dark-mode .status-dropdown {
        background-color: var(--background-dark);
        color: var(--text-dark);
        border-color: var(--border-light);
    }
    .status-dropdown:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
    }

    /* Action buttons in table */
    .action-button-group {
        display: flex;
        flex-direction: column; /* Stack buttons */
        gap: 5px; /* Space between buttons */
    }
    .action-button-group button {
        background-color: var(--primary-blue);
        color: white;
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.2s ease;
    }
    .action-button-group button:hover {
        background-color: #006DED;
    }
    .action-button-group .delete-button {
        background-color: var(--error-red);
    }
    .action-button-group .delete-button:hover {
        background-color: #E63946;
    }

    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--white);
      margin: auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 700px;
      position: relative;
      animation-name: animatetop;
      animation-duration: 0.4s;
      max-height: 90vh; /* Limit height */
      overflow-y: auto; /* Enable scrolling for content */
    }
    body.dark-mode .modal-content {
        background-color: var(--background-light);
    }
    .close-button {
      color: var(--text-medium);
      position: absolute;
      top: 15px;
      right: 25px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .close-button:hover,
    .close-button:focus {
      color: var(--text-dark);
      text-decoration: none;
    }
    @keyframes animatetop {
      from {top: -300px; opacity: 0}
      to {top: 0; opacity: 1}
    }

    /* Form styles within modal (reusing some from index.html) */
    .modal .form-group {
        margin-bottom: 16px;
    }
    .modal .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-dark);
    }
    .modal .form-group input[type="text"],
    .modal .form-group input[type="number"],
    .modal .form-group textarea {
        width: calc(100% - 24px); /* Adjust for padding */
        padding: 12px;
        border: 1px solid var(--border-light);
        border-radius: 8px;
        font-size: 16px;
        background-color: var(--background-light);
        color: var(--text-dark);
    }
    .modal .form-group input[type="text"]:focus,
    .modal .form-group input[type="number"]:focus,
    .modal .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    }
    .modal .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }
    .modal .button-group {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        justify-content: flex-end;
    }
    .modal .button-group button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .modal .button-group button.primary {
        background-color: var(--primary-blue);
        color: var(--white);
    }
    .modal .button-group button.primary:hover {
        background-color: #006DED;
        transform: translateY(-1px);
    }
    .modal .button-group button.secondary {
        background-color: var(--background-light);
        color: var(--text-dark);
        border: 1px solid var(--border-light);
    }
    .modal .button-group button.secondary:hover {
        background-color: #E0E0E5;
        transform: translateY(-1px);
    }
    .modal .item-list-edit {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid var(--border-light); /* Added border to list */
        border-radius: 8px; /* Rounded corners for the list */
        overflow: hidden; /* Ensures border-radius applies to content */
    }
    .modal .item-list-edit li {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping on small screens */
        justify-content: space-between;
        align-items: flex-start; /* Align items to the top */
        padding: 12px; /* Increased padding */
        border-bottom: 1px solid var(--border-light);
        background-color: var(--white); /* Item background */
    }
    .modal .item-list-edit li:nth-child(even) { /* Stripe effect */
        background-color: var(--table-stripe);
    }
    body.dark-mode .modal .item-list-edit li:nth-child(even) {
        background-color: var(--table-stripe); /* Dark mode stripe */
    }
    .modal .item-list-edit li:last-child {
        border-bottom: none;
    }
    .modal .item-list-edit .item-details-display {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        margin-right: 15px; /* Increased space before controls */
        min-width: 150px; /* Ensure some minimum width */
    }
    .modal .item-list-edit .item-details-display strong {
        color: var(--text-dark);
        font-size: 1.1em; /* Slightly larger item ID */
    }
    .modal .item-list-edit .item-details-display span {
        font-size: 0.9em;
        color: var(--text-medium);
        margin-top: 2px; /* Space between ID and name */
    }
    .modal .item-list-edit .item-controls {
        display: flex;
        align-items: center;
        gap: 10px; /* Increased gap */
        flex-shrink: 0; /* Prevent shrinking */
        margin-top: 5px; /* Space if wrapping */
    }
    .modal .item-list-edit .item-controls label {
        margin-bottom: 0; /* Remove label margin */
        font-weight: normal; /* Less bold */
        color: var(--text-medium);
    }
    .modal .item-list-edit .item-controls input[type="number"] {
        width: 70px; /* Wider width for quantity input */
        padding: 8px; /* Increased padding */
        text-align: center;
        font-size: 1em; /* Standard font size */
        border-radius: 6px; /* Rounded corners */
        background-color: var(--background-light);
        color: var(--text-dark);
    }
    .modal .item-list-edit .item-controls button {
        padding: 8px 12px; /* Increased padding */
        font-size: 0.9em; /* Slightly larger font */
        border-radius: 6px; /* Rounded corners */
        background-color: var(--error-red); /* Consistent delete button color */
        color: white;
    }
    .modal .item-list-edit .item-notes-input { /* Style for item notes input in modal */
        width: calc(100% - 2px); /* Full width within its container, accounting for border */
        margin-top: 10px; /* More space above notes */
        font-size: 0.9em;
        min-height: 50px; /* Taller notes field */
        padding: 10px; /* Increased padding */
        border-radius: 8px; /* Rounded corners */
        border: 1px solid var(--border-light);
        background-color: var(--background-light);
        color: var(--text-dark);
    }
    /* Responsive adjustments for modal items */
    @media (max-width: 600px) {
        .modal .item-list-edit li {
            flex-direction: column;
            align-items: flex-start;
            padding: 10px; /* Slightly less padding on mobile */
        }
        .modal .item-list-edit .item-details-display {
            margin-bottom: 10px;
            margin-right: 0;
            width: 100%;
        }
        .modal .item-list-edit .item-controls {
            width: 100%;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .modal .item-list-edit .item-notes-input {
            width: calc(100% - 20px); /* Adjust for padding */
        }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-nav">
      <button onclick="google.script.run.withSuccessHandler(function(url) { window.open(url, '_top'); }).getIndexFileUrl()">Back to Portal</button>
    </div>
    <div style="flex-grow: 1; text-align: center;">
        </div>
    <div class="header-nav"> <button id="darkModeToggle" class="header-nav-button">Toggle Dark Mode</button>
    </div>
  </div>

  <div class="container">
    <h2 class="section-title">Order History</h2>
    <table class="order-history-table">
        <thead>
            <tr>
                <th>Order #</th>
                <th>Timestamp</th>
                <th>Items</th>
                <th>Order Notes</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="orderHistoryTableBody">
            <tr><td colspan="6" style="text-align: center; color: var(--text-medium);">Loading order history...</td></tr>
        </tbody>
    </table>
    <div id="messages"></div>
  </div>

  <!-- Edit Order Modal -->
  <div id="editOrderModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeEditOrderModal()">&times;</span>
      <h2 class="section-title">Edit Order <span id="modalOrderNum"></span></h2>

      <div class="form-group">
        <label for="modalOrderNotes">Order Notes:</label>
        <textarea id="modalOrderNotes" placeholder="Notes for the entire order"></textarea>
      </div>

      <h3 style="font-size: 18px; margin-top: 20px; margin-bottom: 10px; color: var(--text-dark);">Items in Order:</h3>
      <ul id="modalItemsList" class="item-list-edit">
        <!-- Items will be rendered here -->
      </ul>

      <h3 style="font-size: 18px; margin-top: 20px; margin-bottom: 10px; color: var(--text-dark);">Add New Item to Order:</h3>
      <div class="form-group">
        <label for="modalNewItemId">Item ID / Name:</label>
        <input type="text" id="modalNewItemId" list="modalItemIDs" placeholder="Start typing item ID or name..." autocomplete="off">
        <datalist id="modalItemIDs"></datalist>
      </div>
      <div class="form-group">
        <label for="modalNewQuantity">Quantity:</label>
        <input type="number" id="modalNewQuantity" value="1" min="1">
      </div>
      <div class="form-group">
        <label for="modalNewItemNotes">Item Notes (optional):</label>
        <input type="text" id="modalNewItemNotes" placeholder="e.g., specific color, urgent need">
      </div>
      <div class="button-group">
        <button type="button" class="secondary" onclick="addItemToModal()">Add Item to Order</button>
      </div>

      <div class="button-group">
        <button type="button" class="primary" onclick="saveOrderChanges()">Save Changes</button>
        <button type="button" class="secondary" onclick="closeEditOrderModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // showMessage function MUST be defined globally (at the top of the script)
    function showMessage(msg, type) {
      const messagesDiv = document.getElementById('messages');
      if (messagesDiv) {
        messagesDiv.textContent = msg;
        messagesDiv.className = 'message ' + type + ' show'; // Add 'show' class for visibility and transition
        setTimeout(() => {
          messagesDiv.classList.remove('show'); // Remove 'show' after delay to hide it
          messagesDiv.textContent = ''; // Clear text
          messagesDiv.className = 'message'; // Reset classes
        }, 5000);
      } else {
        console.warn('Message div not found.');
      }
    }

    let currentEditingOrderNum = null; // Stores the order number being edited
    let currentEditingItems = []; // Stores items for the order being edited in the modal
    let availableItemDetails = []; // To store all item ID/Name pairs for datalist
    let allOrdersData = []; // NEW: Cache for all orders loaded from getOrdersWithItems

    // Helper function to normalize strings for comparison (e.g., remove special characters)
    function normalizeString(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Order History DOMContentLoaded");
        
        // Dark Mode Initialization
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('light');
                }
            });
        }
        
        loadOrderHistory();
        loadAllItemDetailsForModal(); // Load item details for the modal's datalist
    });

    function loadAllItemDetailsForModal() {
        google.script.run
            .withSuccessHandler(function(itemDetails) {
                availableItemDetails = itemDetails;
                const datalist = document.getElementById('modalItemIDs');
                datalist.innerHTML = '';
                if (availableItemDetails && availableItemDetails.length > 0) {
                    availableItemDetails.forEach(item => {
                        const option = document.createElement('option');
                        option.value = `${item.id} - ${item.name}`;
                        datalist.appendChild(option);
                    });
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error loading all item details for modal:', error);
                // No need to show message to user, as this is a background load
            })
            .getAllItemDetails(); // This function already exists in code.gs
    }


    function loadOrderHistory() {
      console.log('Attempting to load order history...');
      const tbody = document.getElementById('orderHistoryTableBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-medium);">Loading order history...</td></tr>'; 

      google.script.run
        .withSuccessHandler(function(orders) {
          console.log('Orders received:', orders);
          allOrdersData = orders; // NEW: Cache all orders data
          tbody.innerHTML = ''; // Clear loading message

          if (!orders || orders.length === 0) {
            console.log('No orders found or received an empty array.');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-medium);">No orders found.</td></tr>';
            return;
          }

          orders.forEach(order => {
            console.log('Processing order:', order);
            const row = tbody.insertRow();

            // Order # (Column 1)
            row.insertCell().setAttribute('data-label', 'Order #');
            row.cells[0].textContent = order.orderNum;

            // Timestamp (Column 2)
            row.insertCell().setAttribute('data-label', 'Timestamp');
            const date = new Date(order.timestamp);
            row.cells[1].textContent = date.toLocaleString();

            // Items (Column 3)
            const itemsCell = row.insertCell();
            itemsCell.setAttribute('data-label', 'Items');
            const itemList = document.createElement('ul');
            itemList.classList.add('order-item-list');
            const orderItems = Array.isArray(order.items) ? order.items : [];
            
            console.log('DEBUG: Items for order', order.orderNum, ':', JSON.stringify(orderItems));

            orderItems.forEach(item => {
              const li = document.createElement('li');
              const itemNameDisplay = item.itemName ? ` (${item.itemName})` : '';
              const itemNotesDisplay = item.itemNotes ? `<div class="item-notes-display">${item.itemNotes}</div>` : '';
              
              li.innerHTML = `
                <strong>${item.itemId || 'N/A'}</strong>
                <span class="item-name-qty">${itemNameDisplay} (Qty: ${item.qty || 'N/A'})</span>
                ${itemNotesDisplay}`;
              itemList.appendChild(li);
            });
            if (orderItems.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No items';
                itemList.appendChild(li);
            }
            itemsCell.appendChild(itemList);

            // Order Notes (Column 4)
            row.insertCell().setAttribute('data-label', 'Order Notes');
            row.cells[3].textContent = order.orderNotes || 'N/A';

            // Status (Column 5)
            const statusCell = row.insertCell();
            statusCell.setAttribute('data-label', 'Status');
            const statusDropdown = document.createElement('select');
            statusDropdown.classList.add('status-dropdown');
            const statuses = ['Pending', 'Processing', 'Completed', 'Cancelled'];
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                if (status === order.status) {
                    option.selected = true;
                }
                statusDropdown.appendChild(option);
            });
            statusDropdown.dataset.order = order.orderNum;
            statusDropdown.onchange = function() {
                updateOrderStatus(this.dataset.order, this.value);
            };
            statusCell.appendChild(statusDropdown);

            // Actions Cell (Column 6)
            const actionsCell = row.insertCell();
            actionsCell.setAttribute('data-label', 'Actions');
            const actionButtonGroup = document.createElement('div');
            actionButtonGroup.classList.add('action-button-group');

            // Edit button (only for Pending orders)
            if (order.status === 'Pending') {
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.classList.add('primary'); // Or a suitable class for edit
                editButton.onclick = function() {
                    openEditOrderModal(order.orderNum);
                };
                actionButtonGroup.appendChild(editButton);
            }

            // Conditional Cancel/Delete Buttons
            if (order.status !== 'Cancelled') {
                // Cancel Button (appears if not already cancelled)
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.classList.add('delete-button'); // Use delete-button for red style
                cancelButton.onclick = function() {
                    cancelOrderWithConfirmation(order.orderNum); // Calls function to set status to 'Cancelled'
                };
                actionButtonGroup.appendChild(cancelButton);
            } else {
                // Delete Button (appears ONLY if status is 'Cancelled')
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete Permanently';
                deleteButton.classList.add('delete-button'); // Use delete-button for red style
                deleteButton.onclick = function() {
                    deleteOrderPermanentlyWithConfirmation(order.orderNum); // Calls function to delete from sheets
                };
                actionButtonGroup.appendChild(deleteButton);
            }

            actionsCell.appendChild(actionButtonGroup);
          });
        })
        .withFailureHandler(function(error) {
          console.error('Error loading order history:', error);
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--error-red);">Failed to load orders: ' + error.message + '. Please try again later.</td></tr>'; 
          showMessage('Error loading order history: ' + error.message, 'error');
        })
        .getOrdersWithItems();
    }

    function updateOrderStatus(orderNum, newStatus) {
      showMessage(`Updating order ${orderNum} status to ${newStatus}...`, 'info');
      google.script.run
        .withSuccessHandler(function() {
          showMessage(`Order ${orderNum} status updated to ${newStatus}.`, 'success');
          // No need to reload entire history, just update the local dropdown selection
        })
        .withFailureHandler(function(error) {
          showMessage('Error updating order status: ' + error.message, 'error');
          // Optional: Reload order history or revert dropdown if update fails
          // loadOrderHistory(); 
        })
        .updateOrderStatusByOrderNum(orderNum, newStatus);
    }
    
    // Function to initiate cancellation (sets status to 'Cancelled')
    function cancelOrderWithConfirmation(orderNum) {
        const confirmation = prompt(`To confirm cancellation of order ${orderNum}, please type the order number exactly as shown:`);
        if (confirmation === orderNum) {
            showMessage(`Cancelling order ${orderNum}...`, 'info');
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        showMessage(`Order ${orderNum} cancelled successfully!`, 'success');
                        loadOrderHistory(); // Refresh table to show update (will now show 'Delete' button)
                    } else {
                        showMessage(`Failed to cancel order ${orderNum}.`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage(`Error cancelling order ${orderNum}: ${error.message}`, 'error');
                })
                .cancelOrder(orderNum); // Calls the backend function to change status
        } else if (confirmation !== null) {
            showMessage('Order number mismatch. Cancellation aborted.', 'error');
        } else {
            showMessage('Order cancellation aborted.', 'info');
        }
    }

    // NEW: Function to permanently delete a CANCELLED order
    function deleteOrderPermanentlyWithConfirmation(orderNum) {
        const confirmation = prompt(`WARNING: This will permanently delete order ${orderNum} from the system. This action cannot be undone. To confirm, please type the order number exactly as shown:`);
        if (confirmation === orderNum) {
            showMessage(`Deleting order ${orderNum} permanently...`, 'info');
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        showMessage(`Order ${orderNum} permanently deleted!`, 'success');
                        loadOrderHistory(); // Refresh table to remove the deleted order
                    } else {
                        showMessage(`Failed to permanently delete order ${orderNum}.`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage(`Error deleting order ${orderNum} permanently: ${error.message}`, 'error');
                })
                .deleteOrderPermanently(orderNum); // NEW: Calls the backend function to delete rows
        } else if (confirmation !== null) {
            showMessage('Order number mismatch. Permanent deletion aborted.', 'error');
        } else {
            showMessage('Permanent deletion aborted.', 'info');
        }
    }

    // --- Edit Order Modal Functions ---
    function openEditOrderModal(orderNum) {
        currentEditingOrderNum = orderNum;
        document.getElementById('modalOrderNum').textContent = orderNum;
        document.getElementById('editOrderModal').style.display = 'flex'; // Show modal

        const cachedOrder = allOrdersData.find(order => order.orderNum === orderNum);

        if (cachedOrder) {
            console.log('Loading order details from cache for editing:', orderNum);
            document.getElementById('modalOrderNotes').value = cachedOrder.orderNotes || '';
            currentEditingItems = JSON.parse(JSON.stringify(cachedOrder.items || [])); // Deep copy
            renderModalItems();
            showMessage('Order details loaded from cache.', 'success');
        } else {
            console.log('Loading order details from server (cache miss) for editing:', orderNum);
            showMessage('Loading order details for editing...', 'info');
            google.script.run
                .withSuccessHandler(function(order) {
                    if (order) {
                        document.getElementById('modalOrderNotes').value = order.orderNotes || '';
                        currentEditingItems = order.items || [];
                        renderModalItems();
                        showMessage('Order details loaded from server.', 'success');
                    } else {
                        showMessage('Order not found for editing.', 'error');
                        closeEditOrderModal();
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('Error loading order for editing: ' + error.message, 'error');
                    console.error('Error loading order for editing:', error);
                    closeEditOrderModal();
                })
                .getSingleOrderDetails(orderNum);
        }
    }

    function closeEditOrderModal() {
        document.getElementById('editOrderModal').style.display = 'none'; // Hide modal
        currentEditingOrderNum = null;
        currentEditingItems = [];
        // Clear modal form fields
        document.getElementById('modalOrderNotes').value = '';
        document.getElementById('modalNewItemId').value = '';
        document.getElementById('modalNewQuantity').value = '1';
        document.getElementById('modalNewItemNotes').value = '';
        document.getElementById('modalItemsList').innerHTML = ''; // Clear items list
    }

    function renderModalItems() {
        const list = document.getElementById('modalItemsList');
        list.innerHTML = '';
        if (currentEditingItems.length === 0) {
            list.innerHTML = '<li>No items in this order.</li>';
        } else {
            currentEditingItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-details-display">
                        <strong>${item.itemId}</strong>
                        <span>${item.itemName}</span>
                        <textarea class="item-notes-input" placeholder="Item notes (optional)"
                                  data-index="${index}">${item.itemNotes || ''}</textarea>
                    </div>
                    <div class="item-controls">
                        <label>Qty:</label>
                        <input type="number" value="${item.qty}" min="1" data-index="${index}" onchange="updateModalItemQuantity(this)">
                        <button class="delete-button" data-index="${index}" onclick="removeModalItem(this)">Remove</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }
    }

    function updateModalItemQuantity(inputElement) {
        const index = parseInt(inputElement.dataset.index);
        const newQty = parseInt(inputElement.value);
        if (!isNaN(newQty) && newQty > 0) {
            currentEditingItems[index].qty = newQty;
        } else {
            inputElement.value = currentEditingItems[index].qty; // Revert if invalid
            showMessage('Quantity must be a positive number.', 'error');
        }
    }

    // Event listener for notes input (using 'input' for real-time updates)
    document.getElementById('modalItemsList').addEventListener('input', function(event) {
        if (event.target.classList.contains('item-notes-input')) {
            const index = parseInt(event.target.dataset.index);
            currentEditingItems[index].itemNotes = event.target.value.trim();
        }
    });

    function removeModalItem(button) {
        const index = parseInt(button.dataset.index);
        if (confirm('Are you sure you want to remove this item from the order?')) {
            currentEditingItems.splice(index, 1);
            renderModalItems(); // Re-render the list
            showMessage('Item removed from order (not yet saved).', 'info');
        }
    }

    function addItemToModal() {
        const itemIdInput = document.getElementById('modalNewItemId');
        const quantityInput = document.getElementById('modalNewQuantity');
        const itemNotesInput = document.getElementById('modalNewItemNotes');

        const inputVal = itemIdInput.value.trim();
        const quantity = parseInt(quantityInput.value);
        const itemNotes = itemNotesInput.value.trim();

        if (!inputVal) {
            showMessage('Please enter an Item ID or select from the list.', 'error');
            return;
        }
        if (isNaN(quantity) || quantity <= 0) {
            showMessage('Quantity must be a positive number.', 'error');
            return;
        }

        let selectedItem = null;
        const normalizedInputVal = normalizeString(inputVal);

        selectedItem = availableItemDetails.find(item => {
            const normalizedItemCombined = normalizeString(`${item.id} - ${item.name}`);
            return normalizedItemCombined === normalizedInputVal;
        });

        if (!selectedItem) {
            selectedItem = availableItemDetails.find(item => normalizeString(item.id) === normalizedInputVal);
        }
        
        if (!selectedItem) {
            showMessage('Invalid Item ID or Name. Please select from the list or enter a valid ID.', 'error');
            return;
        }

        const itemId = selectedItem.id;
        const itemName = selectedItem.name;

        // Check if item with same ID and notes already exists in currentEditingItems
        const existingItemIndex = currentEditingItems.findIndex(item => 
            item.itemId === itemId && item.itemNotes === itemNotes
        );

        if (existingItemIndex > -1) {
            currentEditingItems[existingItemIndex].qty += quantity;
            showMessage(`Updated quantity for existing item in modal.`, 'info');
        } else {
            currentEditingItems.push({ itemId, itemName, qty: quantity, itemNotes: itemNotes });
            showMessage(`Added new item to modal (not yet saved).`, 'success');
        }

        renderModalItems();
        itemIdInput.value = '';
        quantityInput.value = '1';
        itemNotesInput.value = '';
    }

    function saveOrderChanges() {
        if (!currentEditingOrderNum) {
            showMessage('No order selected for editing.', 'error');
            return;
        }

        const newOrderNotes = document.getElementById('modalOrderNotes').value.trim();

        if (currentEditingItems.length === 0) {
            if (!confirm('This order has no items. Do you want to save it as an empty order or cancel?')) {
                return;
            }
        }

        showMessage('Saving changes...', 'info');
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.success) {
                    showMessage(`Order ${currentEditingOrderNum} updated successfully!`, 'success');
                    closeEditOrderModal();
                    loadOrderHistory(); // Reload table to reflect changes
                } else {
                    showMessage(`Failed to save changes: ${response.message || 'Unknown error'}`, 'error');
                }
            })
            .withFailureHandler(function(error) {
                showMessage('Error saving changes: ' + error.message, 'error');
                console.error('Save changes failure:', error);
            })
            .updateOrder(currentEditingOrderNum, newOrderNotes, currentEditingItems);
    }

  </script>
</body>
</html>
